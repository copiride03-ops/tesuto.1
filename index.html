<!-- Á¨¨1ÂõûÔºöHTMLÊßãÈÄ†„Å®Âü∫Êú¨„Çπ„Çø„Ç§„É´ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÊúàÈÅ∏Êäû‰∫àÂÆö„Ç´„É¨„É≥„ÉÄ„Éº</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9f9f9; }
    h1 { margin-top: 20px; }
    select { font-size: 1rem; padding: 5px; margin: 10px; }
    table { margin: auto; border-collapse: collapse; width: 90%; max-width: 600px; }
    th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
    th { background: #eee; }
    td.today { background: #ffeeba; }
    .tag { font-weight: bold; color: #007bff; }
    .note { font-size: 0.9em; color: #555; margin-top: 4px; }
    #modal, #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    #overlay { background: rgba(0,0,0,0.5); z-index: 9; }
    #modal { background: white; z-index: 10; padding: 20px; margin: auto; top: 20%; left: 50%; transform: translateX(-50%); width: 300px; border-radius: 8px; box-shadow: 0 0 10px #333; }
    #modal input, #modal textarea { width: 100%; margin: 5px 0; }
    #modal button { margin: 5px; }
  </style>
</head>
<body>
  <h1>ÊúàÈÅ∏Êäû‰∫àÂÆö„Ç´„É¨„É≥„ÉÄ„Éº</h1>
  <label for="monthSelect">Ë°®Á§∫„Åô„ÇãÊúàÔºö</label>
  <select id="monthSelect"></select>
  <div id="calendarArea"></div>

  <div id="overlay"></div>
  <div id="modal">
    <p id="modalDate"></p>
    <input id="tagInput" placeholder="„Çø„Ç∞Ôºà‰æãÔºöÂπ¥‰ºëÔºâ" />
    <textarea id="noteInput" rows="3" placeholder="„É°„É¢Ôºà‰æãÔºöÊóÖË°åÔºâ"></textarea>
    <button onclick="saveSchedule()">‰øùÂ≠ò</button>
    <button onclick="deleteSchedule()">ÂâäÈô§</button>
    <button onclick="closeModal()">Èñâ„Åò„Çã</button>
  </div>

<!-- Á¨¨2ÂõûÔºöGoogle SheetsÈÄ£Êê∫„Å®Êúà‰∏ÄË¶ßÁîüÊàê -->
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbxsRQBnFrxg0LbL5W1zRXiCOpfCxg_l-BXxm3B1XMN2Vg5rdLUlxsuttUfi-1-Q0Bo8fQ/exec";

  const monthSelect = document.getElementById("monthSelect");
  const calendarArea = document.getElementById("calendarArea");
  let monthsList = [];
  const today = new Date();

  function pad(n) {
    return n.toString().padStart(2, "0");
  }

  function generateMonthList() {
    monthsList = [];
    for (let i = -3; i <= 3; i++) {
      const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const key = `${y}-${pad(m)}`;
      monthsList.push(key);

      const option = document.createElement("option");
      option.value = key;
      option.textContent = `${y}Âπ¥${m}Êúà`;
      monthSelect.appendChild(option);
    }
  }

  async function loadScheduleFromSheets() {
    const res = await fetch(scriptURL);
    const rows = await res.json();
    scheduleData = {};
    for (const [date, tag, note] of rows) {
      const [y, m] = date.split("-").map(Number);
      const prefix = `schedule-${y}-${pad(m)}`;
      if (!scheduleData[prefix]) scheduleData[prefix] = {};
      scheduleData[prefix][date] = { tag, note };
    }
  }
</script>

<!-- Á¨¨3ÂõûÔºö„Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîª„Å®„É¢„Éº„ÉÄ„É´Ë°®Á§∫ -->
<script>
  let scheduleData = {};
  let selectedDateKey = "";
  let selectedMonthKey = "";

  const modal = document.getElementById("modal");
  const overlay = document.getElementById("overlay");
  const modalDate = document.getElementById("modalDate");
  const tagInput = document.getElementById("tagInput");
  const noteInput = document.getElementById("noteInput");

  function generateCalendar(year, month) {
    calendarArea.innerHTML = "";
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const weekdayRow = document.createElement("tr");
    weekdayRow.innerHTML = `<th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th><th>Êú®</th><th>Èáë</th><th>Âúü</th>`;
    thead.appendChild(weekdayRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const startDay = firstDay.getDay();
    const totalDays = lastDay.getDate();

    const keyPrefix = `schedule-${year}-${pad(month)}`;
    let row = document.createElement("tr");
    for (let i = 0; i < startDay; i++) row.appendChild(document.createElement("td"));

    for (let day = 1; day <= totalDays; day++) {
      const cell = document.createElement("td");
      cell.textContent = day;
      const key = `${year}-${pad(month)}-${pad(day)}`;
      cell.onclick = () => openModal(keyPrefix, key, year, month, day);

      if (year === today.getFullYear() && month === today.getMonth() + 1 && day === today.getDate()) {
        cell.classList.add("today");
      }

      const data = scheduleData[keyPrefix]?.[key];
      if (data) {
        if (data.tag) {
          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = data.tag;
          cell.appendChild(tag);
        }
        if (data.note) {
          const note = document.createElement("div");
          note.className = "note";
          note.textContent = data.note;
          cell.appendChild(note);
        }
      }

      row.appendChild(cell);
      if ((startDay + day) % 7 === 0 || day === totalDays) {
        tbody.appendChild(row);
        row = document.createElement("tr");
      }
    }

    table.appendChild(tbody);
    calendarArea.appendChild(table);
  }

  function openModal(prefix, key, year, month, day) {
    selectedDateKey = key;
    selectedMonthKey = prefix;
    modalDate.textContent = `${year}Âπ¥${month}Êúà${day}Êó•„ÅÆ‰∫àÂÆö`;
    const data = scheduleData[prefix]?.[key] || {};
    tagInput.value = data.tag || "";
    noteInput.value = data.note || "";
    modal.style.display = "block";
    overlay.style.display = "block";
  }

  function closeModal() {
    modal.style.display = "none";
    overlay.style.display = "none";
  }
</script>

<!-- Á¨¨4ÂõûÔºà‰øÆÊ≠£ÁâàÔºâÔºö‰øùÂ≠ò„ÉªÂâäÈô§„ÉªÂàùÊúüÂåñ„ÉªÈñâ„Åò„Çø„Ç∞ -->
<script>
  async function saveSchedule() {
    const payload = {
      date: selectedDateKey,
      tag: tagInput.value,
      note: noteInput.value
    };

    await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    closeModal();
    await loadScheduleFromSheets();
    const [y, m] = selectedDateKey.split("-").map(Number);
    generateCalendar(y, m);
  }

  async function deleteSchedule() {
    alert("ÂâäÈô§Ê©üËÉΩ„ÅØÊú™ÂÆüË£Ö„Åß„Åô„ÄÇ\nÂøÖË¶Å„Åß„ÅÇ„Çå„Å∞ doDelete() „ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ");
    closeModal();
  }

  monthSelect.addEventListener("change", () => {
    const [y, m] = monthSelect.value.split("-").map(Number);
    generateCalendar(y, m);
  });

  // üîß ÂàùÊúüÂåñÂá¶ÁêÜ
  (async () => {
    generateMonthList();
    monthSelect.value = `${today.getFullYear()}-${pad(today.getMonth() + 1)}`;
    await loadScheduleFromSheets();
    generateCalendar(today.getFullYear(), today.getMonth() + 1);
  })();
</script>
</body>
</html>

